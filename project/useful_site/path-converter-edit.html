<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>폴더 트리 기반 경로 변환기</title>
    <link
      href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Fira Code", monospace;
        background: #1e1e1e;
        color: #d4d4d4;
        margin: 0;
        padding: 2rem;
      }
      .container {
        max-width: 1400px;
        margin: auto;
        display: flex;
        gap: 2rem;
      }
      .left,
      .right {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .tree {
        background: #1e1e1e;
        padding: 1rem;
        border: 1px solid #555;
        border-radius: 0.5rem;
        max-height: 400px;
        overflow-y: auto;
      }
      ul {
        list-style: none;
        padding-left: 1rem;
      }
      li {
        margin: 0.25rem 0;
        padding: 5px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      li.drag-over {
        background: #444;
      }
      .start {
        color: #4fc3f7;
        font-weight: bold;
      }
      .target {
        color: #81c784;
        font-weight: bold;
      }
      .context-menu {
        position: absolute;
        z-index: 1000;
        background: #333;
        border: 1px solid #666;
        padding: 0.5rem;
        border-radius: 5px;
        display: none;
      }
      .context-menu button {
        background: none;
        border: none;
        color: #fff;
        text-align: left;
        padding: 0.3rem;
        width: 100%;
        cursor: pointer;
      }
      .context-menu button:hover {
        background: #555;
      }
      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #2d2d2d;
        padding: 2rem;
        border: 1px solid #555;
        border-radius: 1rem;
        z-index: 2000;
      }
      .modal input {
        width: 100%;
        padding: 0.5rem;
        background: #1e1e1e;
        color: #fff;
        border: 1px solid #666;
        margin-bottom: 1rem;
      }
      .modal button {
        width: 48%;
        padding: 0.5rem;
        margin: 0.25rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .modal .confirm {
        background: #0e639c;
        color: white;
      }
      .modal .cancel {
        background: #666;
        color: white;
      }
      textarea {
        background: #1e1e1e;
        color: #d4d4d4;
        border: 1px solid #555;
        border-radius: 0.5rem;
        padding: 1rem;
        height: 200px;
        resize: none;
        overflow-y: auto;
        font-family: "Fira Code", monospace;
      }
      textarea::-webkit-scrollbar {
        display: none;
      }
      pre {
        background: #1e1e1e;
        border: 1px solid #555;
        border-radius: 0.5rem;
        padding: 1rem;
        height: 300px;
        overflow-y: auto;
      }
      pre::-webkit-scrollbar {
        display: none;
      }
      .options {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="left">
        <h2>📁 폴더 트리 관리</h2>
        <div
          class="tree"
          id="tree"
          oncontextmenu="showContextMenu(event, null)"
        >
          <ul id="tree-root">
            <li
              draggable="true"
              data-role="start"
              ondragstart="dragStart(event)"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
              oncontextmenu="showContextMenu(event, this)"
            >
              📄 start.html
            </li>
            <li
              draggable="true"
              data-role="target"
              ondragstart="dragStart(event)"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
              oncontextmenu="showContextMenu(event, this)"
            >
              📄 target.html
            </li>
          </ul>
        </div>

        <div class="options">
          <label
            ><input
              type="radio"
              name="mode"
              value="relative"
              checked
              onchange="updatePath()"
            />
            절대 → 상대</label
          >
          <label
            ><input
              type="radio"
              name="mode"
              value="absolute"
              onchange="updatePath()"
            />
            상대 → 절대</label
          >
        </div>

        <textarea
          id="input"
          placeholder="여기에 HTML 코드를 붙여넣으세요"
          oninput="updatePath()"
        ></textarea>
      </div>

      <div class="right">
        <h2>📝 변환된 코드</h2>
        <pre><code id="result" class="language-html"></code></pre>
      </div>
    </div>

    <div class="context-menu" id="context-menu">
      <button onclick="createFolder()">➕ 폴더 추가</button>
      <button onclick="renameItem()">✏️ 이름 수정</button>
      <button onclick="deleteItem()">🗑️ 삭제</button>
    </div>

    <div class="modal" id="modal">
      <input type="text" id="modal-input" placeholder="폴더 이름 입력" />
      <div style="text-align: center">
        <button class="confirm" onclick="confirmModal()">확인</button>
        <button class="cancel" onclick="cancelModal()">취소</button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script>

    <script>
      let draggedItem = null;
      let selectedItem = null;
      let modalMode = "";
      let mode = "relative"; // 기본 변환 모드: 절대 → 상대

      // 드래그 시작
      function dragStart(event) {
        draggedItem = event.target;
      }

      // 드래그 허용
      function allowDrop(event) {
        event.preventDefault();
        event.target.classList.add("drag-over");
      }

      // 드롭
      function drop(event) {
        event.preventDefault();
        event.target.classList.remove("drag-over");
        if (
          draggedItem &&
          event.target.tagName === "LI" &&
          draggedItem !== event.target
        ) {
          let targetUl = event.target.querySelector("ul");
          if (!targetUl) {
            targetUl = document.createElement("ul");
            event.target.appendChild(targetUl);
          }
          targetUl.appendChild(draggedItem);
          updatePath();
        }
      }

      // 우클릭 메뉴
      function showContextMenu(event, item) {
        event.preventDefault();
        selectedItem = item;

        const menu = document.getElementById("context-menu");
        menu.style.top = `${event.pageY}px`;
        menu.style.left = `${event.pageX}px`;
        menu.style.display = "block";
      }

      // 클릭 시 메뉴 숨김
      window.addEventListener("click", () => {
        document.getElementById("context-menu").style.display = "none";
      });

      // 모달 열기
      function openModal(modeType) {
        modalMode = modeType;
        document.getElementById("modal").style.display = "block";
        document.getElementById("modal-input").value = "";
        document.getElementById("modal-input").focus();
      }

      // 모달 닫기
      function cancelModal() {
        document.getElementById("modal").style.display = "none";
      }

      // 폴더 추가
      function createFolder() {
        openModal("create");
      }

      // 이름 수정
      function renameItem() {
        if (!selectedItem || isProtected(selectedItem)) return;
        openModal("rename");
      }

      // 삭제
      function deleteItem() {
        if (!selectedItem || isProtected(selectedItem)) return;
        selectedItem.parentElement.removeChild(selectedItem);
      }

      // 보호된 파일인지 확인
      function isProtected(item) {
        return item.dataset.role === "start" || item.dataset.role === "target";
      }

      // 모달 입력 확인
      function confirmModal() {
        const input = document.getElementById("modal-input").value.trim();
        if (input === "") return;

        if (modalMode === "create") {
          const li = document.createElement("li");
          li.innerHTML = `📁 ${input}`;
          li.draggable = true;
          li.ondragstart = dragStart;
          li.ondrop = drop;
          li.ondragover = allowDrop;
          li.oncontextmenu = (e) => showContextMenu(e, li);

          if (selectedItem) {
            let ul = selectedItem.querySelector("ul");
            if (!ul) {
              ul = document.createElement("ul");
              selectedItem.appendChild(ul);
            }
            ul.appendChild(li);
          } else {
            document.getElementById("tree-root").appendChild(li);
          }
        } else if (modalMode === "rename") {
          const isStart = selectedItem.dataset.role === "start";
          const isTarget = selectedItem.dataset.role === "target";
          if (isStart || isTarget) {
            selectedItem.innerHTML = `📄 ${input}`;
          } else {
            selectedItem.innerHTML = `📁 ${input}`;
          }
        }

        cancelModal();
        updatePath();
      }

      // 변환 모드 변경
      function updateMode() {
        mode = document.querySelector('input[name="mode"]:checked').value;
        updatePath();
      }

      // 시작/변환 파일 경로 추출
      function getPath(item) {
        let path = "";
        while (item && item.tagName === "LI") {
          const text = item.textContent.trim().replace(/^📁\s|^📄\s/, "");
          path = "/" + text + path;
          item = item.parentElement.closest("li");
        }
        return path;
      }

      // 상대 경로 계산
      function calculateRelativePath(fromPath, toPath) {
        const from = fromPath.split("/").filter(Boolean);
        const to = toPath.split("/").filter(Boolean);

        while (from.length && to.length && from[0] === to[0]) {
          from.shift();
          to.shift();
        }

        return "../".repeat(from.length) + to.join("/");
      }

      // 변환 로직
      function updatePath() {
        const startFile = document.querySelector('[data-role="start"]');
        const targetFile = document.querySelector('[data-role="target"]');

        if (!startFile || !targetFile) return;

        const fromPath = getPath(startFile);
        const toPath = getPath(targetFile);

        let transformedPath = "";

        if (mode === "relative") {
          transformedPath = calculateRelativePath(fromPath, toPath);
        } else {
          transformedPath = toPath;
        }

        // 붙여넣은 코드 가져오기
        const inputCode = document.getElementById("input").value;

        // src, href 속성 변환
        let output = inputCode
          .replace(/src="([^"]*)"/g, `src="${transformedPath}"`)
          .replace(/href="([^"]*)"/g, `href="${transformedPath}"`);

        document.getElementById("result").textContent = output;
        Prism.highlightElement(document.getElementById("result"));
      }

      // 라디오 버튼 변경 감지
      document.querySelectorAll('input[name="mode"]').forEach((radio) => {
        radio.addEventListener("change", updateMode);
      });
    </script>
  </body>
</html>
